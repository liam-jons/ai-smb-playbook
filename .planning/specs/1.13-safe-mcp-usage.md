# Spec 1.13 — Safe MCP Usage

> **Phase 2 build agent:** Agent 4 — Developer Track Sections
> **Track:** Developer

## Purpose

This section introduces MCP (Model Context Protocol) servers to Phew!'s development team — what they are, how they extend Claude Code, and critically, how to use them safely. MCP servers are the mechanism by which Claude Code connects to external services (databases, APIs, browsers, documentation sources), but they carry real risks that are poorly documented elsewhere: connections can fail silently mid-session, tools can disappear without warning, and every connected server consumes context window space on every request. This section must be honest about these trade-offs while providing practical guidance for the two MCPs most relevant to Phew!'s workflow (deepwiki and chrome-devtools), plus general setup patterns that apply to any MCP server.

The section cross-references the context window simulator (section 1.2) for visual understanding of MCP context costs, and the governance policy (section 1.5) for the approval process before adding new MCP servers.

## Source References

| File | Path | What to extract |
|------|------|-----------------|
| Capabilities & extension options | `.planning/source-context/claude-code-capabilities-extension-options.md` | PRIMARY. Full MCP documentation: what loads at session start, tool search behaviour (up to 10% of context), scope hierarchy (local > project > user), silent failure behaviour, `/mcp` command, "Context cost by feature" table, MCP vs Skill comparison. |
| Capabilities audit | `.planning/research/capabilities-audit.md` | MCP-specific findings: tool naming pattern (`mcp__<server>__<tool>`), MCP tools unavailable in background subagents, `updatedMCPToolOutput` in PostToolUse hooks. Context cost table with mitigation strategies. Gotchas list. |
| Initial thoughts | `.planning/source-context/phew-initial-thoughts-for-meeting-follow-up.md` | Original requirement: "Setting up and using MCPs safely e.g., deepwiki, chrome-devtools". Confirms the two recommended MCPs. |
| App tech stack | `.planning/research/app-tech-stack.md` | UI component decisions, shadcn/ui components, code block rendering with Shiki + CopyButton pattern. |
| Frontend skills review | `.planning/research/frontend-skills-review.md` | Design guidelines, interaction patterns, accessibility requirements, and the full Build Agent Checklist. |

## Content Outline

### 1. What Are MCP Servers?

**Opening explanation (2–3 paragraphs, plain language):**

MCP (Model Context Protocol) is the standard way to connect Claude Code to external services. Without MCP, Claude can read and write files, run commands, and search the web — but it cannot query your database, control a browser, or pull documentation from a third-party source. MCP servers bridge that gap.

An MCP server is a small programme that runs alongside Claude Code and exposes "tools" — specific actions Claude can take. When you connect a Context7 MCP server, for example, Claude gains a tool to look up documentation for any library. When you connect a Playwright MCP server, Claude gains tools to open a browser, navigate to pages, take screenshots, and interact with elements.

**Key mental model to convey:**
- MCP servers are external processes that Claude Code communicates with
- Each server provides one or more "tools" that Claude can call
- The tools appear in Claude's toolkit just like its built-in tools (file read, file write, bash, etc.)
- The tool naming convention is `mcp__<server-name>__<tool-name>` (e.g., `mcp__context7__query-docs`)

**Diagram/visual suggestion:** A simple flow diagram showing Claude Code in the centre with arrows pointing to 2–3 MCP servers (e.g., "Context7", "Playwright", "GitHub"), each with a small list of tools they provide. Use a layout that conveys "Claude Code talks to these services through MCP". This should be a static SVG or Tailwind-styled diagram, not an interactive component.

### 2. How MCP Affects Your Context Window

**Cross-reference to section 1.2** — link the user back to the interactive context window simulator, but provide a self-contained summary here.

**Key facts to present (use a shadcn Alert or callout):**
- MCP server tool definitions load at **session start** and stay in context for **every request**
- Tool search (enabled by default) loads MCP tools up to **10% of the context window**, deferring the rest until needed
- This means every connected MCP server costs context space even when you are not using it
- More servers = less space for your actual conversation and code

**Practical context cost table:**

| Feature | When it loads | Context cost | Mitigation |
|---------|--------------|-------------|------------|
| MCP server (tool definitions) | Session start | Every request (up to 10% with tool search) | Disconnect unused servers |
| MCP tool invocation | When Claude calls the tool | One-off per call (input + output) | Keep tool outputs focused |
| Multiple MCP servers | Session start (all at once) | Cumulative — each adds to the 10% budget | Only connect what you need |

**Actionable advice:**
- Check your current MCP context cost with `/mcp` — it shows token usage per server
- Disconnect servers you are not actively using in the current session
- If Claude seems to be losing track of earlier context, check whether MCP tools are consuming too much of your window

### 3. Setting Up an MCP Server

**Configuration locations (scope hierarchy):**

MCP servers can be configured at three levels, with local taking precedence:
1. **Local** (`.mcp.json` in the project root) — applies to this project only
2. **Project** (`.claude/settings.json` in the project) — shared with the team via version control
3. **User** (`~/.claude/settings.json`) — applies to all your projects

**Configuration format:**

Two server types relevant to Phew!:

**stdio servers** (run as a local process):
```json
{
  "mcpServers": {
    "context7": {
      "command": "npx",
      "args": ["-y", "@upstash/context7-mcp"]
    }
  }
}
```

**HTTP/SSE servers** (connect to a remote service):
```json
{
  "mcpServers": {
    "sentry": {
      "type": "http",
      "url": "https://mcp.sentry.dev/mcp"
    }
  }
}
```

**Environment variables for credentials:**
```json
{
  "mcpServers": {
    "github": {
      "type": "http",
      "url": "https://api.githubcopilot.com/mcp/",
      "headers": {
        "Authorization": "Bearer ${GITHUB_PERSONAL_ACCESS_TOKEN}"
      }
    }
  }
}
```

**Important: Never hard-code credentials in `.mcp.json`.** Use environment variable references (`${VAR_NAME}`) — Claude Code expands these at runtime.

### 4. Recommended MCPs for Phew!

Present each recommended MCP with a consistent structure: what it does, why it is useful for Phew!, setup instructions, and example usage.

#### 4a. deepwiki

**What it does:** Provides access to documentation for open-source projects directly within Claude Code. Instead of Claude relying on its training data (which may be outdated), deepwiki fetches current documentation from the project's actual source.

**Why it matters for Phew!:** When working with WordPress plugins, ASP.NET libraries, or any third-party dependency, Claude can look up the current documentation rather than guessing from potentially outdated training data. This reduces hallucination risk significantly.

**Setup:**
```json
{
  "mcpServers": {
    "deepwiki": {
      "command": "npx",
      "args": ["-y", "@anthropic/deepwiki-mcp"]
    }
  }
}
```

**Example usage prompt:**
> "Look up the current API for [library name] using deepwiki before implementing this feature."

**Note:** Context7 (covered in section 1.14 as a plugin) provides similar documentation lookup functionality. deepwiki is a standalone MCP server; Context7 is available as both an MCP server and an official plugin. Choose one — running both is redundant and doubles the context cost.

#### 4b. chrome-devtools (Playwright MCP)

**What it does:** Gives Claude Code the ability to control a web browser — navigate to pages, click elements, fill forms, take screenshots, and run end-to-end tests. The Playwright MCP server from Microsoft is the standard browser automation tool for Claude Code.

**Why it matters for Phew!:** Phew! builds web applications (LMS, Audit System, PDMS). Browser automation enables Claude to test pages visually, verify CSS changes, and run regression checks against live or staging environments — complementing or replacing Ghost Inspector workflows (see section 1.12).

**Setup:**
```json
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["@playwright/mcp@latest"]
    }
  }
}
```

**Example usage prompt:**
> "Open the staging site at [URL], navigate to the login page, and take a screenshot to verify the layout."

**Security note:** The Playwright MCP gives Claude full browser control. It can navigate to any URL, submit forms, and interact with authenticated sessions. Use it only on staging/development environments, never on production with real user data.

### 5. Safety Considerations — The Honest Version

**This is the most important subsection. Present it prominently — use a shadcn Alert with a warning variant or a visually distinct callout block.**

#### 5a. Silent Failures

> "MCP connections can fail silently mid-session. If a server disconnects, its tools disappear without warning. Claude may try to use a tool that no longer exists."
> — Claude Code documentation

This is the single most important safety concern with MCP. When an MCP server disconnects (network issue, server crash, process timeout), Claude does not receive an error message. The tools simply stop appearing in its toolkit. Claude may then:
- Attempt to perform the action using a different approach (potentially less reliable)
- Hallucinate a result that looks like a real tool output
- Fail silently and move on without telling you

**What to do about it:**
- Run `/mcp` regularly during sessions that depend on MCP tools
- If Claude suddenly stops using an MCP tool it was using earlier, check the connection
- Do not assume MCP-dependent workflows will complete without supervision

#### 5b. Tool Disappearance

When an MCP server disconnects, all its tools vanish from Claude's available toolkit. There is no notification, no error in the chat, no visual indicator. This is by design in the current protocol — MCP tool availability is checked per-request, and a missing server simply means missing tools.

**Practical impact:** If you are relying on an MCP tool for a multi-step workflow (e.g., "query the database, then update the record"), and the server drops between steps, Claude will complete the second step without database access — potentially using incorrect assumptions.

#### 5c. Context Cost Creep

Every MCP server you leave connected consumes context space on every single request. Even if you connected a server three hours ago for a one-off task and have not used it since, it is still costing you context tokens.

**Mitigation:** Disconnect servers when you finish using them. Run `/mcp` to see what is connected and how much each server costs.

#### 5d. Credential Exposure

MCP servers that require authentication (GitHub, Sentry, Asana) need API tokens or credentials. These must be stored as environment variables, never hard-coded in configuration files that are committed to version control.

**Checklist before adding a new MCP server:**
- What credentials does it need?
- Where will those credentials be stored? (Environment variables, not files)
- Is `.mcp.json` in `.gitignore`? (It should be if it contains credential references)
- Does the server need network access? If so, what endpoints?
- Has this server been approved under the governance policy (section 1.5)?

### 6. Troubleshooting MCP Issues

**Present as a collapsible accordion (shadcn Accordion) with common issues:**

**"Claude stopped using my MCP tool"**
1. Run `/mcp` to check server status
2. If the server shows as disconnected, restart it: close and reopen Claude Code, or reconfigure the server
3. If the server shows as connected but Claude is not using the tool, try explicitly asking: "Use the [server name] MCP tool to..."

**"My MCP server won't start"**
1. Check the command and arguments in your `.mcp.json` — typos are common
2. For stdio servers: verify the package is installed (`npx` downloads on first run, but can fail with network issues)
3. For HTTP/SSE servers: verify the URL is reachable from your machine
4. Check environment variables: `echo $VAR_NAME` to confirm they are set

**"MCP is consuming too much context"**
1. Run `/mcp` — it shows token cost per server
2. Disconnect servers you are not currently using
3. Consider whether a plugin might be more context-efficient than a standalone MCP server (plugins bundle skills that provide context only when invoked)

**"Claude is hallucinating MCP results"**
1. This can happen when an MCP server silently disconnects
2. Run `/mcp` to verify connection status
3. If the server is disconnected, treat any "results" Claude provided after the disconnection as unreliable
4. Reconnect and re-run the operation

### 7. MCP vs Other Extension Options

**Brief comparison to help developers choose the right tool (present as a table or side-by-side comparison):**

| Need | Use | Why |
|------|-----|-----|
| Connect to an external API or service | MCP server | MCP is the protocol for external connections |
| Give Claude knowledge about how to use a service well | Skill (possibly combined with MCP) | Skills provide context and workflows; MCP provides the connection |
| Run a deterministic automation on every file edit | Hook | Hooks run outside the agentic loop — no LLM involved |
| Package MCP + skills + hooks together for the team | Plugin | Plugins bundle multiple extension types into one installable unit |

**Cross-reference:** See section 1.4 (Skills & Extensions Decision Tree) for the full comparison.

### 8. Governance Cross-Reference

**Brief callout (shadcn Alert, informational variant):**

Before adding any new MCP server to a project, follow the approval process in the AI Governance Policy (section 1.5). The governance policy covers:
- Who can approve new MCP connections
- What security review is required (credential handling, data access scope)
- How to document which MCP servers are in use across the team
- Periodic review of connected servers (disconnect what is no longer needed)

The governance policy template in the Starter Kit includes an MCP-specific section with approval criteria. See section 1.16 for the full Starter Kit contents.

## Interaction Design

### Components Used

| Component | Source | Usage |
|-----------|--------|-------|
| `Card` | shadcn/ui | MCP recommendation cards (deepwiki, Playwright) — one card per recommended MCP |
| `Alert` | shadcn/ui | Safety warnings (silent failures, credential exposure), context cost callout, governance cross-reference |
| `Accordion` | shadcn/ui | Troubleshooting section — collapsible items for each common issue |
| `Badge` | shadcn/ui | Labels on MCP cards ("Recommended", "Requires credentials") |
| `Separator` | shadcn/ui | Visual dividers between major subsections |
| `Tooltip` | shadcn/ui | Contextual help on technical terms (e.g., "stdio", "SSE", "tool search") |

### Code Blocks

All JSON configuration examples and terminal commands must use the `CodeBlock` component (Shiki + CopyButton pattern from the app tech stack). Language hints:
- `.mcp.json` examples: `json`
- Terminal commands: `bash`
- Claude prompts: plain text (no syntax highlighting, but still in a copyable block)

### Layout

- **Mobile (< 640px):** Single column. MCP recommendation cards stack. Accordion items are full-width.
- **Tablet (640px–1023px):** MCP recommendation cards may sit side-by-side if space permits. Content is single-column.
- **Desktop (1024px+):** MCP recommendation cards side-by-side. Context cost table is full-width. Max content width: 65ch for body text.

### Diagram

The MCP architecture diagram (subsection 1) should be a simple static SVG or Tailwind-based layout. Do not use a charting library. Three boxes (MCP servers) connected to a central box (Claude Code) with labelled arrows. Responsive: stacks vertically on mobile.

## Copyable Content

Every configuration example and command below must have a copy-to-clipboard button via the `CopyButton` component.

### MCP Configuration — deepwiki
```json
{
  "mcpServers": {
    "deepwiki": {
      "command": "npx",
      "args": ["-y", "@anthropic/deepwiki-mcp"]
    }
  }
}
```

### MCP Configuration — Playwright (chrome-devtools)
```json
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["@playwright/mcp@latest"]
    }
  }
}
```

### MCP Configuration — Generic HTTP server template
```json
{
  "mcpServers": {
    "service-name": {
      "type": "http",
      "url": "https://your-service-url.com/mcp",
      "headers": {
        "Authorization": "Bearer ${YOUR_API_TOKEN}"
      }
    }
  }
}
```

### MCP Configuration — Generic stdio server template
```json
{
  "mcpServers": {
    "service-name": {
      "command": "npx",
      "args": ["-y", "@scope/package-name"]
    }
  }
}
```

### Status Check Command
```bash
/mcp
```
Copy text: `/mcp`

### Example Prompt — deepwiki Usage
```
Look up the current documentation for [library name] using deepwiki before implementing this feature. Check for any breaking changes since the version we are currently using.
```

### Example Prompt — Playwright Usage
```
Open the staging site at [URL], navigate to the login page, and take a screenshot. Compare the layout against the design spec.
```

### MCP Safety Checklist (copyable as a standalone reference)
```markdown
## MCP Safety Checklist

Before adding a new MCP server:
- [ ] What credentials does it need? Where will they be stored?
- [ ] Is `.mcp.json` in `.gitignore`? (if it contains credential references)
- [ ] Has this server been approved under the governance policy?
- [ ] What data can this server access? Is that scope appropriate?

During use:
- [ ] Run `/mcp` at the start of each session to verify connections
- [ ] Run `/mcp` if Claude stops using an MCP tool unexpectedly
- [ ] Disconnect servers when no longer needed for the current task

After use:
- [ ] Remove MCP servers from config if no longer needed
- [ ] Rotate any API tokens that were used
- [ ] Document which MCP servers are active in the project README or CLAUDE.md
```

## Two-Track Considerations

This section is **Developer track only**. MCP servers are configured through Claude Code's settings files and are not available to users of claude.ai or Claude Desktop.

However, the concept of "connecting Claude to external services" is relevant to General track users through Projects and integrations in claude.ai. If the General track section 1.4 (Skills & Extensions Decision Tree) covers the general concept, this section should not repeat it — focus purely on the Claude Code MCP implementation.

**No General track variant is needed.** The General track section 1.4 covers the high-level concept of extensions. This section provides the Claude Code-specific depth.

## Acceptance Criteria

1. The section clearly explains what MCP servers are in plain language, without assuming prior knowledge of the protocol.
2. The context cost implications are explained with specific numbers (10% of context window for tool search) and linked back to section 1.2.
3. At least two recommended MCP servers (deepwiki, Playwright/chrome-devtools) are presented with full setup instructions, copyable configuration, and example usage prompts.
4. The safety section prominently covers silent failure behaviour — including the direct quote from Claude Code documentation about tools disappearing without warning.
5. The credential handling guidance explicitly states: never hard-code credentials, use environment variables, keep `.mcp.json` out of version control if it contains credential references.
6. The troubleshooting accordion covers at least four common issues with actionable solutions.
7. The MCP safety checklist is copyable as a standalone reference.
8. All JSON configuration examples use correct syntax and match the actual format used by Claude Code (verified against the plugin reference files in `starter-kit/plugins/claude-plugins-official/`).
9. The governance policy cross-reference (section 1.5) is present and clearly directs users to the approval process.
10. The comparison table (MCP vs Skills vs Hooks vs Plugins) helps developers choose the right extension type.
11. All body text uses UK English spelling and grammar.
12. All code blocks have copy-to-clipboard buttons.
13. The section is fully navigable by keyboard (accordion items, tooltips, copy buttons).
14. The section functions as a standalone reference — a developer reading only this section and the referenced files has everything they need to set up and safely use MCP servers.
15. The note about Context7 vs deepwiki overlap is present, guiding developers to choose one rather than running both.
16. Touch targets on all interactive elements are at least 44px.
17. The section respects `prefers-reduced-motion` for any animated elements.

## Build Agent Checklist

### Frontend Quality Checklist

**Typography**
- [ ] Body text >= 16px (1rem), using rem units
- [ ] Max line length: 65ch for body text
- [ ] Fluid type (clamp) on headings; fixed sizes on UI controls
- [ ] Font stacks include size-adjusted fallback
- [ ] No generic fonts (Inter, Roboto, etc.) unless explicitly specified

**Colour & Theming**
- [ ] All custom colours defined in OKLCH via CSS variables
- [ ] Neutrals tinted towards brand hue (not pure grey)
- [ ] No pure black (#000) or pure white (#fff)
- [ ] Dark mode tested and functional (if applicable to section)
- [ ] All text meets WCAG AA contrast (4.5:1 body, 3:1 large/UI)

**Layout & Spacing**
- [ ] Spacing values from the 4pt grid (4, 8, 12, 16, 24, 32, 48, 64, 96)
- [ ] Visual hierarchy uses 2+ dimensions (size, weight, colour, space)
- [ ] No nested cards
- [ ] No identical repeating card grids

**Motion & Animation**
- [ ] Only `transform` and `opacity` animated (no width/height/top/left)
- [ ] Timing follows 100/300/500 rule
- [ ] Easing uses exponential curves (not default `ease` or bounce)
- [ ] `prefers-reduced-motion` handled (crossfade fallback or disable)
- [ ] Exit animations faster than entrances
- [ ] Motion used via Tailwind transitions where CSS suffices; Motion library only for layout/enter/exit

**Interaction**
- [ ] All 8 interactive states designed (default, hover, focus, active, disabled, loading, error, success)
- [ ] `:focus-visible` ring on all interactive elements (2-3px, offset, 3:1 contrast)
- [ ] Touch targets >= 44px
- [ ] Copy-to-clipboard on every prompt/template/code block
- [ ] Skeleton screens for loading states (not generic spinners)

**Accessibility**
- [ ] Semantic HTML (headings, landmarks, labels)
- [ ] Skip link present
- [ ] Keyboard navigation tested (Tab, Enter, Escape, Arrows)
- [ ] `aria-expanded`, `aria-controls` on accordions/collapsibles
- [ ] `aria-label` on icon-only buttons
- [ ] Images have `alt` text (or `alt=""` for decorative)
- [ ] Never `outline: none` without `:focus-visible` replacement

**Performance**
- [ ] No barrel file imports (direct imports from source)
- [ ] Shiki lazy-loaded (not in initial bundle)
- [ ] Derived state computed during render (no useEffect for derived values)
- [ ] `content-visibility: auto` on long scrollable content
- [ ] Passive event listeners on scroll/touch handlers
- [ ] Static JSX hoisted outside components where possible

**Responsive**
- [ ] Mobile-first (base styles for mobile, min-width queries for larger)
- [ ] Tested at 320px, 640px, 768px, 1024px widths
- [ ] No critical functionality hidden on mobile
- [ ] Hover-dependent features have touch alternatives
- [ ] Safe area insets handled for mobile

**UX Writing & Content**
- [ ] UK English throughout (spelling, grammar, currency, date format)
- [ ] Button labels use verb + object pattern
- [ ] Error messages answer: what, why, how to fix
- [ ] Consistent terminology (no synonyms for the same action)
- [ ] Empty states are actionable, not just "Nothing here"

**Code Quality**
- [ ] Tailwind utility classes only (no CSS modules or styled-components)
- [ ] `cn()` utility for conditional class merging
- [ ] `@/` path alias for all imports
- [ ] Components composed from shadcn primitives (not mega-components)
- [ ] Content defined as typed TS objects, not hard-coded JSX
